# 中文汉字笔画应用开发复盘（Flutter / Android）

## 1. 目标与交付范围

本次开发目标是交付一个“首页 + 详情页”的中文汉字笔画应用（Flutter，Android 优先）：

- 首页支持输入 1~20 个汉字查询。
- 支持按拼音 / 笔画 / 部首筛选。
- 详情页支持笔顺展示与控制：上一笔 / 播放暂停 / 下一笔。
- 离线字库可用（无网络可查）。
- UI 风格尽量贴近参考截图。

---

## 2. 关键编码步骤（按阶段）

### 阶段 A：工程与架构落地

1. 建立 Flutter 工程骨架与模块结构（home/detail/dictionary）。
2. 明确数据契约（`CharacterEntry`、`StrokePath`、`StrokePlayerState`）。
3. 采用 `flutter_riverpod` 做状态管理，播放器逻辑集中到 controller。

### 阶段 B：离线字库接入与索引

1. 字库放入 `assets/data/chars_3500.json`（后续升级为真实大字库）。
2. 仓储层加载 JSON 并构建索引：
   - `byChar`
   - `byPinyin`
   - `byRadical`
   - `byStrokeCount`
3. 输入清洗：仅保留汉字，限制长度 1~20。

### 阶段 C：首页与详情页 UI 还原

1. 首页实现：
   - 顶部搜索区
   - 三个筛选入口（拼音/笔画/部首）
   - “汉字举例”“易错汉字”卡片网格
2. 详情页实现：
   - 标题与顶部工具行
   - 方格画布
   - 播放控制按钮区
3. 样式统一：浅粉背景、棕红按钮、红色米字格/边框。

### 阶段 D：笔顺播放问题修复（这次最核心）

用户多次反馈“字形不对、笔顺不对、和参考图不一致”，最终的修复关键点：

1. 用真实笔画数据替换占位/合成数据（避免“字写错”）。
2. 修正坐标系方向（Y 轴翻转适配），解决上下颠倒/错位问题。
3. 调整画布渲染层：
   - 已完成笔画：黑色
   - 当前笔画：红色
   - 未播放笔画：浅灰
4. 修正播放器会话状态隔离，避免上一个字状态污染当前字。
5. 增加“打开详情页自动播放”，并把速度调慢（`speed=0.6`）。

### 阶段 E：Android 可安装能力打通

最初环境报错：`No Android SDK found`。后续完成：

1. 安装 Android command-line tools。
2. 安装 SDK 组件与许可。
3. `flutter doctor` 校验通过 Android toolchain。
4. 成功打包 `release apk` 并验签。

---

## 3. 本次高频/关键命令清单

### 基础开发命令

```bash
cd /Users/jyy/Documents/bihua
flutter pub get
flutter test
flutter analyze
```

### 运行与打包

```bash
flutter run -d chrome
flutter run -d android
flutter build apk --release
```

### Android 环境排查

```bash
flutter doctor -v
flutter config --android-sdk ~/Library/Android/sdk
flutter doctor --android-licenses
flutter devices
```

### 用 sdkmanager 安装 SDK 组件（命令行方式）

```bash
yes | ~/Library/Android/sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/Library/Android/sdk --licenses
yes | ~/Library/Android/sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/Library/Android/sdk "platform-tools" "platforms;android-35" "build-tools;35.0.0"
yes | ~/Library/Android/sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/Library/Android/sdk "platforms;android-36" "build-tools;36.0.0" "build-tools;28.0.3"
```

### APK 验证与安装

```bash
~/Library/Android/sdk/build-tools/36.0.0/apksigner verify --print-certs /Users/jyy/Documents/bihua/build/app/outputs/flutter-apk/app-release.apk
adb install -r /Users/jyy/Documents/bihua/build/app/outputs/flutter-apk/app-release.apk
```

---

## 4. 这次遇到的典型问题与处理

### 问题 1：`flutter` 或 Android SDK 不可用

- 现象：`command not found` / `No Android SDK found`。
- 处理：安装 Flutter + SDK，`flutter config --android-sdk ...`，再跑 `flutter doctor -v`。

### 问题 2：Gradle 下载依赖报 `Tag mismatch`

- 现象：首次 `flutter build apk --release` 在网络下载阶段失败。
- 处理：让 Flutter 自动重试，并补齐自动触发缺失组件（如 NDK、CMake）后再构建。

### 问题 3：字形正确但笔顺视觉不对

- 根因：笔画数据源/坐标系/渲染顺序不一致。
- 处理：真实数据 + 坐标校正 + 播放状态逻辑统一。

---

## 5. 当前产物与状态

- APK 已可构建：`/Users/jyy/Documents/bihua/build/app/outputs/flutter-apk/app-release.apk`
- 当前为 **Debug 证书签名**（可安装测试）。
- 代码可运行、测试可通过（`flutter test`）。
- `flutter analyze` 仍有少量 warning/info（不阻塞打包，可后续清理）。

---

## 6. 推荐你继续练习的路线

1. 把 APK 切换为正式 keystore 签名（学习发布流程）。
2. 清理 `flutter analyze` 里的 warning，提升工程质量。
3. 为播放器补充更多测试场景（首笔、末笔、连续切换、自动播放中断恢复）。
4. 增加真机性能观测（帧率、首屏时间、内存峰值）。

---

## 7. 这次我犯过的关键 Bug（重点：汉字播放）

这部分是本次最有学习价值的地方，按“现象 -> 根因 -> 修复”记录。

### Bug A：字形不对、像“写错字”

- 现象：用户反馈“字不对”“和参考图差异很大”，例如“字”显示形态异常。
- 根因：早期数据里有占位/合成笔画，不能代表真实字形。
- 修复：替换为真实字形数据，来源改为 Make Me a Hanzi 的图形与字典数据组合。

### Bug B：笔顺顺序看起来不对

- 现象：当前高亮笔和参考 App 不一致，顺序错乱。
- 根因：当前笔绘制逻辑与数据坐标方向不一致（Y 轴方向问题），并且部分状态切换时索引/进度衔接不稳定。
- 修复：
  1. 在 `CharacterEntry.fromJson` 中根据中线数据自动启用 `flipYAxis`（`/Users/jyy/Documents/bihua/lib/features/dictionary/domain/character_entry.dart`）。
  2. 在 `StrokeCanvas` 中渲染时统一应用坐标翻转与 bounds 计算（`/Users/jyy/Documents/bihua/lib/features/detail/presentation/widgets/stroke_canvas.dart`）。
  3. 在 `StrokePlayerController` 里统一处理 completed/next/previous 的边界，避免跳笔（`/Users/jyy/Documents/bihua/lib/features/detail/application/stroke_player_controller.dart`）。

### Bug C：播放状态串台（上一个字影响下一个字）

- 现象：切字后播放状态残留，出现一进详情页就处于错误笔画位置。
- 根因：播放器 provider key 粒度不够，导致会话状态被复用。
- 修复：引入 `StrokePlayerKey(sessionId + char + totalStrokes)` 做详情页会话隔离（`/Users/jyy/Documents/bihua/lib/features/detail/application/stroke_player_controller.dart`）。

### Bug D：详情页打开行为与预期不一致

- 现象：用户要求“打开详情页自动播放，速度稍慢”，早期行为不符合。
- 根因：初始状态和自动播放触发时机未统一，导致视觉上像“未按预期开始”。
- 修复：在详情页首帧回调中设置速度 `0.6` 并自动触发播放（`/Users/jyy/Documents/bihua/lib/features/detail/presentation/detail_page.dart`）。

### Bug E：画布对齐/范围异常

- 现象：出现红框区域和字形中心不一致，局部看起来“跑位”。
- 根因：字形 source bounds 与渲染缩放在翻转坐标前后未保持一致。
- 修复：`StrokeCanvas` 里先计算统一 source bounds，再做等比缩放和居中平移，最后应用翻转。

---

## 8. `chars_3500.json` 最终来源（具体到文件）

### 8.1 最终来源

- 最终字库文件：`/Users/jyy/Documents/bihua/assets/data/chars_3500.json`
- 实际条目数：9565（当前离线可查的 CJK 字）
- 来源仓库：Make Me a Hanzi  
  - 仓库地址：`https://github.com/skishore/makemeahanzi`
  - 图形数据文件：`graphics.txt`
  - 字典数据文件：`dictionary.txt`

### 8.2 生成映射关系（本项目用到的字段）

- `char`：字本身（来自字典记录）。
- `pinyin` / `radical`：来自字典信息。
- `strokeCount`：由笔画条目数量统计。
- `strokes[].svgPath`：来自图形数据中的每笔 SVG path。
- `strokes[].medianPoints`：来自图形数据中的每笔中线点序列（用于更稳定地表现播放轨迹）。
- `examples`：在入库时保留为空数组或按需补充。

### 8.3 许可证与分发注意事项

- 当前数据说明文件：`/Users/jyy/Documents/bihua/assets/data/LICENSE.md`
- 该来源采用 `CC BY-SA 4.0`，分发时需要保留来源与许可证声明。
- 文件名仍叫 `chars_3500.json` 是历史命名；当前内容已不止 3500 字（为 9565 条）。
